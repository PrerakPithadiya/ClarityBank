/**
 * @file Firestore Security Rules for ClarityBank.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model, ensuring
 * that only authenticated users can access and modify their own data. All data
 * is nested under /users/{userId}, with further subcollections for bank accounts
 * and transactions.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/bankAccounts/{bankAccountId}: Stores bank account information
 *   for each user. Each bank account document includes a denormalized 'userId'
 *   field for authorization.
 * - /users/{userId}/bankAccounts/{bankAccountId}/transactions/{transactionId}:
 *   Stores transaction history for each bank account. Each transaction document
 *   includes denormalized 'bankAccountId' and 'userId' fields.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own user document.
 * - Users can only manage bank accounts and transactions associated with their
 *   user ID.
 * - The 'list' operation is allowed for all subcollections, enabling users to
 *   view their bank accounts and transaction history.
 * - Authorization Independence is achieved by denormalizing the `userId` in
 *   `bankAccounts` and both `bankAccountId` and `userId` in `transactions`.
 *   This eliminates the need for `get()` calls in security rules, allowing
 *   for atomic operations.
 * - Balance updates are validated to prevent withdrawals that would result in
 *   a negative balance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their profile.
     * @allow (get) User with ID 'user123' reads their profile.
     * @allow (update) User with ID 'user123' updates their profile.
     * @allow (delete) User with ID 'user123' deletes their profile.
     * @deny (create) User with ID 'user123' attempts to create a profile for 'user456'.
     * @deny (update) User with ID 'user123' attempts to update profile for 'user456'.
     * @deny (delete) User with ID 'user123' attempts to delete profile for 'user456'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own bank accounts.
     * @path /users/{userId}/bankAccounts/{bankAccountId}
     * @allow (create) User with ID 'user123' creates a bank account for themselves.
     * @allow (get) User with ID 'user123' reads their own bank account.
     * @allow (list) User with ID 'user123' lists their bank accounts.
     * @allow (update) User with ID 'user123' updates their own bank account.
     * @allow (delete) User with ID 'user123' deletes their own bank account.
     * @deny (create) User with ID 'user123' attempts to create a bank account for 'user456'.
     * @deny (update) User with ID 'user123' attempts to update bank account for 'user456'.
     * @deny (delete) User with ID 'user123' attempts to delete bank account for 'user456'.
     * @principle Enforces document ownership for writes and allows owner-only reads.
     */
    match /users/{userId}/bankAccounts/{bankAccountId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(path);
      }

      // Validates that the incoming balance is a number.
      function isBalanceValid() {
        return request.resource.data.balance is number;
      }

      // Validates a withdrawal request.
      function isValidWithdrawal(currentBalance, newBalance) {
        // Ensure new balance is not negative and is less than the current balance.
        let isNotNegative = newBalance >= 0;
        let isDecreasing = newBalance < currentBalance;
        return isNotNegative && isDecreasing;
      }
      
      // Validates a deposit request.
      function isValidDeposit(currentBalance, newBalance) {
          // Ensure new balance is greater than the current balance.
          return newBalance > currentBalance;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isSignedIn() &&
                       isExistingOwner(userId) &&
                       request.resource.data.userId == resource.data.userId &&
                       isBalanceValid() &&
                       (isValidDeposit(resource.data.balance, request.resource.data.balance) || 
                        isValidWithdrawal(resource.data.balance, request.resource.data.balance));

      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage transactions for their own bank accounts.
     * @path /users/{userId}/bankAccounts/{bankAccountId}/transactions/{transactionId}
     * @allow (create) User 'user123' creates a transaction for their bank account.
     * @allow (get) User 'user123' reads a transaction for their bank account.
     * @allow (list) User 'user123' lists transactions for their bank account.
     * @allow (update) User 'user123' updates a transaction for their bank account.
     * @allow (delete) User 'user123' deletes a transaction for their bank account.
     * @deny (create) User 'user123' attempts to create a transaction for 'user456'.
     * @deny (update) User 'user123' attempts to update transaction for 'user456'.
     * @deny (delete) User 'user123' attempts to delete transaction for 'user456'.
     * @principle Enforces document ownership for writes and allows owner-only reads.
     */
    match /users/{userId}/bankAccounts/{bankAccountId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      // Transactions are immutable once created.
      allow create: if isSignedIn() && 
                       isOwner(userId) && 
                       request.resource.data.bankAccountId == bankAccountId &&
                       request.resource.data.amount > 0; // Amount must be positive
      allow update: if false; 
      allow delete: if false;
    }
  }
}
